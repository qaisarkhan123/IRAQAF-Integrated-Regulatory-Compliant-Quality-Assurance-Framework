{% extends "base.html" %}

{% block title %}Setup 2FA - IRAQAF Dashboard{% endblock %}

{% block content %}
<div class="fade-in">
    <div class="row justify-content-center">
        <div class="col-12 col-md-10 col-lg-8 col-xl-6">
            <div class="card">
                <div class="card-header">
                    <h4 class="card-title mb-0">
                        <i class="fas fa-shield-alt me-2"></i>
                        Setup Two-Factor Authentication
                    </h4>
                </div>
                <div class="card-body">
                    <div class="alert alert-info">
                        <i class="fas fa-info-circle me-2"></i>
                        <strong>Enhanced Security:</strong> Two-factor authentication adds an extra layer of security to your account.
                    </div>

                    <div class="row">
                        <div class="col-md-6">
                            <h5>Step 1: Scan QR Code</h5>
                            <p class="text-muted">Use your authenticator app (Google Authenticator, Authy, etc.) to scan this QR code:</p>
                            
                            <div class="text-center mb-3">
                                <img src="{{ qr_code }}" alt="2FA QR Code" class="img-fluid" style="max-width: 200px;">
                            </div>
                            
                            <div class="alert alert-warning">
                                <small>
                                    <i class="fas fa-exclamation-triangle me-1"></i>
                                    <strong>Can't scan?</strong> Manually enter this secret in your app:<br>
                                    <code>{{ secret }}</code>
                                </small>
                            </div>
                        </div>
                        
                        <div class="col-md-6">
                            <h5>Step 2: Verify Setup</h5>
                            <p class="text-muted">Enter the 6-digit code from your authenticator app to complete setup:</p>
                            
                            <form method="POST" action="{{ url_for('enable_2fa') }}">
                                <div class="form-group mb-3">
                                    <label for="verification_token" class="form-label">Verification Code</label>
                                    <input type="text" 
                                           class="form-control text-center" 
                                           id="verification_token" 
                                           name="verification_token" 
                                           required 
                                           placeholder="000000"
                                           maxlength="6"
                                           pattern="[0-9]{6}"
                                           autocomplete="one-time-code"
                                           style="font-size: 1.2rem; letter-spacing: 0.2em;">
                                </div>
                                
                                <button type="submit" class="btn btn-primary w-100">
                                    <i class="fas fa-check me-2"></i>
                                    Enable 2FA
                                </button>
                            </form>
                        </div>
                    </div>

                    <hr>

                    <div class="backup-codes-section">
                        <h5>
                            <i class="fas fa-key me-2"></i>
                            Backup Recovery Codes
                        </h5>
                        <div class="alert alert-warning">
                            <i class="fas fa-exclamation-triangle me-2"></i>
                            <strong>Important:</strong> Save these backup codes in a safe place. You can use them to access your account if you lose your authenticator device.
                        </div>
                        
                        <div class="row">
                            {% for code in backup_codes %}
                            <div class="col-md-6 mb-2">
                                <div class="backup-code">
                                    <code>{{ code }}</code>
                                </div>
                            </div>
                            {% endfor %}
                        </div>
                        
                        <div class="mt-3">
                            <button class="btn btn-secondary" onclick="downloadBackupCodes()">
                                <i class="fas fa-download me-2"></i>
                                Download Backup Codes
                            </button>
                            <button class="btn btn-outline-secondary" onclick="printBackupCodes()">
                                <i class="fas fa-print me-2"></i>
                                Print Backup Codes
                            </button>
                        </div>
                    </div>
                </div>
                <div class="card-footer">
                    <a href="{{ url_for('settings') }}" class="btn btn-outline-secondary">
                        <i class="fas fa-arrow-left me-2"></i>
                        Back to Settings
                    </a>
                </div>
            </div>
        </div>
    </div>
</div>

<style>
.backup-code {
    background: #f8f9fa;
    border: 1px solid #dee2e6;
    border-radius: 6px;
    padding: 8px 12px;
    font-family: 'Courier New', monospace;
    font-size: 0.9rem;
    text-align: center;
}

.backup-codes-section {
    margin-top: 2rem;
    padding-top: 2rem;
    border-top: 1px solid #dee2e6;
}
</style>

<script>
// Format 2FA input
document.addEventListener('DOMContentLoaded', function() {
    const verificationInput = document.getElementById('verification_token');
    if (verificationInput) {
        verificationInput.addEventListener('input', function(e) {
            // Only allow numbers
            this.value = this.value.replace(/[^0-9]/g, '');
        });
        
        // Auto-focus
        verificationInput.focus();
    }
});

function downloadBackupCodes() {
    const codes = [
        {% for code in backup_codes %}
        "{{ code }}"{% if not loop.last %},{% endif %}
        {% endfor %}
    ];
    
    const content = "IRAQAF Dashboard - 2FA Backup Codes\n" +
                   "Generated: " + new Date().toLocaleString() + "\n" +
                   "Username: {{ session.username }}\n\n" +
                   "Backup Codes:\n" +
                   codes.map((code, index) => `${index + 1}. ${code}`).join('\n') +
                   "\n\nKeep these codes safe and secure!";
    
    const blob = new Blob([content], { type: 'text/plain' });
    const url = window.URL.createObjectURL(blob);
    const a = document.createElement('a');
    a.href = url;
    a.download = 'iraqaf-2fa-backup-codes.txt';
    document.body.appendChild(a);
    a.click();
    document.body.removeChild(a);
    window.URL.revokeObjectURL(url);
}

function printBackupCodes() {
    const codes = [
        {% for code in backup_codes %}
        "{{ code }}"{% if not loop.last %},{% endif %}
        {% endfor %}
    ];
    
    const printContent = `
        <html>
        <head>
            <title>IRAQAF 2FA Backup Codes</title>
            <style>
                body { font-family: Arial, sans-serif; margin: 40px; }
                .header { text-align: center; margin-bottom: 30px; }
                .codes { display: grid; grid-template-columns: 1fr 1fr; gap: 10px; margin: 20px 0; }
                .code { background: #f5f5f5; padding: 10px; border: 1px solid #ddd; text-align: center; font-family: monospace; }
                .warning { background: #fff3cd; border: 1px solid #ffeaa7; padding: 15px; margin: 20px 0; }
            </style>
        </head>
        <body>
            <div class="header">
                <h1>üõ°Ô∏è IRAQAF Dashboard</h1>
                <h2>Two-Factor Authentication Backup Codes</h2>
                <p>Generated: ${new Date().toLocaleString()}</p>
                <p>Username: {{ session.username }}</p>
            </div>
            
            <div class="codes">
                ${codes.map((code, index) => `<div class="code">${index + 1}. ${code}</div>`).join('')}
            </div>
            
            <div class="warning">
                <strong>‚ö†Ô∏è Important Security Notice:</strong>
                <ul>
                    <li>Keep these codes in a safe and secure location</li>
                    <li>Each code can only be used once</li>
                    <li>Use these codes if you lose access to your authenticator device</li>
                    <li>Do not share these codes with anyone</li>
                </ul>
            </div>
        </body>
        </html>
    `;
    
    const printWindow = window.open('', '_blank');
    printWindow.document.write(printContent);
    printWindow.document.close();
    printWindow.print();
}
</script>
{% endblock %}
