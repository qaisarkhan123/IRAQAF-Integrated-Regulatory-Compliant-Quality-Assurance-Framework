{% extends "base.html" %}

{% block title %}Dashboard - IRAQAF{% endblock %}

{% block content %}
<div class="fade-in">
    <!-- Dashboard Header -->
    <div class="row mb-5">
        <div class="col-12">
            <div class="card glass-card floating-element">
                <div class="card-body" style="padding: 3rem;">
                    <div class="row align-items-center">
                        <div class="col-lg-8 col-md-12">
                            <div class="d-flex align-items-center mb-3">
                                <div class="dashboard-shield-icon me-3 me-md-4">üõ°Ô∏è</div>
                                <div>
                                    <h1 class="dashboard-title mb-2">
                                        IRAQAF Dashboard
                                    </h1>
                                    <p class="dashboard-subtitle mb-0">
                                        Integrated Regulatory & Compliance Quality Assurance Framework
                                    </p>
                                </div>
                            </div>
                            <div class="d-flex align-items-center gap-3 mb-3">
                                <div class="status-badge success">
                                    ‚úì SYSTEM ONLINE
                                </div>
                                <div class="status-badge info">
                                    üìä REAL-TIME MONITORING
                                </div>
                                <div class="status-badge primary">
                                    üîí SECURE ACCESS
                                </div>
                            </div>
                            <h3 class="welcome-text">
                                Welcome back, {{ username }}! üëã
                            </h3>
                            <p class="welcome-description">
                                Monitor compliance metrics, security status, and hub performance in real-time
                            </p>
                        </div>
                        <div class="col-lg-4 col-md-12 text-center mt-3 mt-lg-0">
                            <div class="d-flex flex-column gap-3 align-items-center">
                                <div class="glass-card p-3 px-5 text-center">
                                    <div style="font-size: 2rem; margin-bottom: 0.5rem;">üïí</div>
                                    <div class="fw-bold" style="color: var(--primary-main); font-size: 1.1rem;">
                                        {{ current_time.strftime('%I:%M %p') }}
                                    </div>
                                    <div style="color: var(--text-muted); font-size: 0.875rem;">
                                        {{ current_time.strftime('%A, %B %d, %Y') }}
                                    </div>
                                </div>
                                <div class="d-flex gap-2 justify-content-center">
                                    <button class="btn btn-secondary" onclick="refreshDashboard()">
                                        üîÑ Refresh
                                    </button>
                                    <a href="/settings" class="btn btn-primary">
                                        ‚öôÔ∏è Settings
                                    </a>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Key Metrics Section -->
    <div class="mb-5">
        <div class="d-flex align-items-center justify-content-between mb-4">
            <h2 class="text-gradient mb-0">üìä Key Performance Metrics</h2>
            <div class="badge badge-info">Live Data</div>
        </div>
        
        <div class="modern-grid">
            <div class="metric-card floating-element">
                <div class="metric-icon">üèõÔ∏è</div>
                <div class="metric-label">Compliance Score (CRS)</div>
                <div class="metric-value" data-metric="crs">
                    {% if metrics.crs != 'N/A' %}
                        {{ "%.1f"|format(metrics.crs) }}%
                    {% else %}
                        N/A
                    {% endif %}
                </div>
                <div class="metric-trend">
                    {% if metrics.crs != 'N/A' and metrics.crs > 80 %}
                        <span class="positive">‚Üó +2.3% from last week</span>
                    {% elif metrics.crs != 'N/A' %}
                        <span class="negative">‚Üò -1.2% from last week</span>
                    {% endif %}
                </div>
            </div>

            <div class="metric-card floating-element">
                <div class="metric-icon">üîê</div>
                <div class="metric-label">Security Index (SAI)</div>
                <div class="metric-value" data-metric="sai">
                    {% if metrics.sai != 'N/A' %}
                        {{ "%.1f"|format(metrics.sai) }}%
                    {% else %}
                        N/A
                    {% endif %}
                </div>
                <div class="metric-trend">
                    {% if metrics.sai != 'N/A' and metrics.sai > 80 %}
                        <span class="positive">‚Üó +1.2% from last week</span>
                    {% elif metrics.sai != 'N/A' %}
                        <span class="negative">‚Üò -0.8% from last week</span>
                    {% endif %}
                </div>
            </div>

            <div class="metric-card floating-element">
                <div class="metric-icon">‚öñÔ∏è</div>
                <div class="metric-label">Fairness Index (FI)</div>
                <div class="metric-value" data-metric="fi">
                    {% if metrics.fi != 'N/A' %}
                        {{ "%.1f"|format(metrics.fi) }}%
                    {% else %}
                        N/A
                    {% endif %}
                </div>
                <div class="metric-trend">
                    {% if metrics.fi != 'N/A' and metrics.fi < 70 %}
                        <span class="negative">‚Üò -0.5% from last week</span>
                    {% elif metrics.fi != 'N/A' %}
                        <span class="positive">‚Üó +1.8% from last week</span>
                    {% endif %}
                </div>
            </div>

            <div class="metric-card floating-element">
                <div class="metric-icon">üîç</div>
                <div class="metric-label">Transparency Score (TS)</div>
                <div class="metric-value" data-metric="ts">
                    {% if metrics.ts != 'N/A' %}
                        {{ "%.1f"|format(metrics.ts) }}%
                    {% else %}
                        N/A
                    {% endif %}
                </div>
                <div class="metric-trend">
                    {% if metrics.ts != 'N/A' and metrics.ts > 80 %}
                        <span class="positive">‚Üó +3.1% from last week</span>
                    {% elif metrics.ts != 'N/A' %}
                        <span class="negative">‚Üò -1.5% from last week</span>
                    {% endif %}
                </div>
            </div>
        </div>
    </div>

    <!-- Unified CQS Row -->
    <div class="row mb-4">
        <div class="col-md-4">
            <div class="metric-card">
                <div class="metric-label">üéØ Unified Continuous QA Score (CQS)</div>
                <div class="metric-value" data-metric="cqs">
                    {% if metrics.cqs != 'N/A' %}
                        {{ "%.1f"|format(metrics.cqs) }}%
                    {% else %}
                        N/A
                    {% endif %}
                </div>
                <div class="mt-2">
                    {% if metrics.cqs != 'N/A' %}
                        {% if metrics.cqs >= 80 %}
                            <span class="badge bg-success">üü¢ Excellent</span>
                        {% elif metrics.cqs >= 60 %}
                            <span class="badge bg-warning">üü° Good</span>
                        {% else %}
                            <span class="badge bg-danger">üî¥ Needs Attention</span>
                        {% endif %}
                    {% else %}
                        <span class="badge bg-secondary">üîÑ Loading...</span>
                    {% endif %}
                </div>
            </div>
        </div>

        <div class="col-md-4">
            <div class="metric-card">
                <div class="metric-label">‚ö†Ô∏è Active Alerts</div>
                <div class="metric-value">{{ alert_summary.total }}</div>
                {% if alert_summary.critical > 0 %}
                    <small class="text-danger">{{ alert_summary.critical }} Critical</small>
                {% elif alert_summary.warning > 0 %}
                    <small class="text-warning">{{ alert_summary.warning }} Warnings</small>
                {% else %}
                    <small class="text-success">All Clear</small>
                {% endif %}
            </div>
        </div>

        <div class="col-md-4">
            <div class="metric-card">
                <div class="metric-label">‚ö° Avg Response</div>
                <div class="metric-value">
                    {% if avg_response %}
                        {{ "%.0f"|format(avg_response) }}ms
                    {% else %}
                        N/A
                    {% endif %}
                </div>
                <small class="text-muted">Hub API Response Time</small>
            </div>
        </div>
    </div>

    <!-- System Overview Section -->
    <div class="row mb-5">
        <div class="col-lg-8">
            <div class="card glass-card">
                <div class="card-header" style="background: linear-gradient(135deg, var(--primary-main) 0%, var(--accent-indigo) 100%); color: white; border-radius: 20px 20px 0 0;">
                    <div class="d-flex align-items-center">
                        <div class="me-3" style="font-size: 1.5rem;">üåê</div>
                        <div>
                            <h3 class="mb-0" style="font-weight: 800;">Hub Status Overview</h3>
                            <p class="mb-0 opacity-75" style="font-size: 0.875rem;">Real-time monitoring of all system components</p>
                        </div>
                    </div>
                </div>
                <div class="card-body" style="padding: 2rem;">
                    <div class="row mb-4">
                        <div class="col-md-3">
                            <div class="glass-card p-3 text-center">
                                <div style="font-size: 2rem; margin-bottom: 0.5rem;">üìä</div>
                                <h3 class="text-gradient mb-1">{{ total_hubs }}</h3>
                                <div style="color: var(--text-muted); font-weight: 600;">Total Hubs</div>
                            </div>
                        </div>
                        <div class="col-md-3">
                            <div class="glass-card p-3 text-center">
                                <div style="font-size: 2rem; margin-bottom: 0.5rem;">‚úÖ</div>
                                <h3 class="text-gradient mb-1">{{ online_hubs }}/{{ total_hubs }}</h3>
                                <div style="color: var(--text-muted); font-weight: 600;">Online Hubs</div>
                            </div>
                        </div>
                        <div class="col-md-3">
                            <div class="glass-card p-3 text-center">
                                <div style="font-size: 2rem; margin-bottom: 0.5rem;">‚ö°</div>
                                <h3 class="text-gradient mb-1">{{ "%.1f"|format(system_uptime) }}%</h3>
                                <div style="color: var(--text-muted); font-weight: 600;">System Uptime</div>
                            </div>
                        </div>
                        <div class="col-md-3">
                            <div class="glass-card p-3 text-center">
                                <div style="font-size: 2rem; margin-bottom: 0.5rem;">üëÅÔ∏è</div>
                                <a href="{{ url_for('hub_overview') }}" class="btn btn-primary">
                                    View Details
                                </a>
                            </div>
                        </div>
                    </div>

                    <!-- Hub Status Cards (Compact) -->
                    <div class="row">
                        {% for name, status in health_status.items() %}
                        <div class="col-md-6 mb-2">
                            <div class="hub-status-card {{ 'hub-status-online' if status.online else 'hub-status-offline' }}">
                                <div class="d-flex align-items-center justify-content-between">
                                    <div class="d-flex align-items-center">
                                        <span class="me-2" style="font-size: 1.2em;">{{ status.icon }}</span>
                                        <div>
                                            <div class="fw-bold">{{ name }}</div>
                                            <small class="text-muted">Port: {{ status.port }}</small>
                                        </div>
                                    </div>
                                    <div class="text-end">
                                        <div class="mb-1">
                                            {% if status.online %}
                                                <span class="badge badge-success">‚úì Online</span>
                                            {% else %}
                                                <span class="badge badge-danger">‚úó Offline</span>
                                            {% endif %}
                                        </div>
                                        {% if status.online and status.response_time %}
                                            {% if status.response_time < 100 %}
                                                <small style="color: var(--success);">{{ "%.0f"|format(status.response_time) }}ms</small>
                                            {% elif status.response_time < 300 %}
                                                <small style="color: var(--warning);">{{ "%.0f"|format(status.response_time) }}ms</small>
                                            {% else %}
                                                <small style="color: var(--error);">{{ "%.0f"|format(status.response_time) }}ms</small>
                                            {% endif %}
                                        {% endif %}
                                    </div>
                                </div>
                            </div>
                        </div>
                        {% endfor %}
                    </div>
                </div>
            </div>
        </div>

        <div class="col-md-4">
            <div class="card">
                <div class="card-header">
                    <h5 class="card-title mb-0">
                        <i class="fas fa-exclamation-triangle"></i> Recent Alerts
                    </h5>
                </div>
                <div class="card-body">
                    {% if alerts %}
                        {% for alert in alerts[:5] %}
                        <div class="alert-card alert-{{ alert.severity }} mb-2">
                            <div class="d-flex align-items-start">
                                <span class="me-2" style="font-size: 1.1rem;">{{ alert.icon }}</span>
                                <div class="flex-grow-1">
                                    <div class="fw-bold" style="margin-bottom: 0.25rem;">{{ alert.title }}</div>
                                    <div style="font-size: 0.875rem; opacity: 0.8;">{{ alert.source }}</div>
                                </div>
                                <div class="text-end">
                                    <div class="badge badge-{{ alert.severity }}" style="font-size: 0.7rem;">
                                        {{ alert.severity.upper() }}
                                    </div>
                                    <div style="font-size: 0.75rem; margin-top: 0.25rem; opacity: 0.7;">
                                        {{ alert.timestamp.strftime('%H:%M') }}
                                    </div>
                                </div>
                            </div>
                        </div>
                        {% endfor %}
                        
                        {% if alerts|length > 5 %}
                        <div class="text-center mt-3">
                            <a href="{{ url_for('alerts_page') }}" class="btn btn-outline-primary btn-sm">
                                View All {{ alerts|length }} Alerts
                            </a>
                        </div>
                        {% endif %}
                    {% else %}
                    <div class="text-center py-4">
                        <i class="fas fa-check-circle text-success" style="font-size: 2rem;"></i>
                        <p class="mt-2 mb-0">No active alerts</p>
                        <small class="text-muted">All systems operating normally</small>
                    </div>
                    {% endif %}
                </div>
            </div>
        </div>
    </div>

    <!-- Quick Actions Row -->
    <div class="row mb-4">
        <div class="col-12">
            <div class="card glass-card">
                <div class="card-body" style="padding: 2rem;">
                    <h4 class="mb-4" style="color: #1f2937; font-weight: 700; display: flex; align-items: center; gap: 0.5rem;">
                        ‚ö° Quick Actions
                    </h4>
                    <div class="row g-3">
                        <div class="col-lg-3 col-md-6 col-sm-6 col-12">
                            <a href="{{ url_for('hub_overview') }}" class="quick-action-btn">
                                <div class="quick-action-icon">üåê</div>
                                <div class="quick-action-text">Hub Overview</div>
                            </a>
                        </div>
                        <div class="col-lg-3 col-md-6 col-sm-6 col-12">
                            <a href="{{ url_for('charts') }}" class="quick-action-btn">
                                <div class="quick-action-icon">üìà</div>
                                <div class="quick-action-text">Interactive Charts</div>
                            </a>
                        </div>
                        <div class="col-lg-3 col-md-6 col-sm-6 col-12">
                            <a href="{{ url_for('alerts_page') }}" class="quick-action-btn">
                                <div class="quick-action-icon">üö®</div>
                                <div class="quick-action-text">Alerts Management</div>
                            </a>
                        </div>
                        <div class="col-lg-3 col-md-6 col-sm-6 col-12">
                            <a href="javascript:void(0)" class="quick-action-btn" onclick="location.reload()">
                                <div class="quick-action-icon">üîÑ</div>
                                <div class="quick-action-text">Refresh Data</div>
                            </a>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Hub Links Row -->
    <div class="row">
        <div class="col-12">
            <div class="card glass-card">
                <div class="card-body" style="padding: 2rem;">
                    <h4 class="mb-4" style="color: #1f2937; font-weight: 700; display: flex; align-items: center; gap: 0.5rem;">
                        üîó Direct Hub Access
                    </h4>
                    <div class="row g-3">
                        {% for name, status in health_status.items() %}
                        <div class="col-xl-4 col-lg-6 col-md-6 col-sm-12">
                            {% if status.online %}
                            <a href="http://localhost:{{ status.port }}" target="_blank" class="hub-access-btn">
                                <div class="hub-status-indicator online"></div>
                                <div class="hub-icon">{{ status.icon }}</div>
                                <div class="hub-name">{{ name }}</div>
                                <div class="hub-status">Online</div>
                            </a>
                            {% else %}
                            <div class="hub-access-btn disabled">
                                <div class="hub-status-indicator offline"></div>
                                <div class="hub-icon">{{ status.icon }}</div>
                                <div class="hub-name">{{ name }}</div>
                                <div class="hub-status">Offline</div>
                            </div>
                            {% endif %}
                        </div>
                        {% endfor %}
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>
{% endblock %}

{% block extra_js %}
<script>
    // Load real data asynchronously after page loads
    {% if fast_load %}
    document.addEventListener('DOMContentLoaded', function() {
        // Show loading indicator
        console.log('Loading real dashboard data...');
        
        // Fetch real data
        fetch('/api/dashboard-data')
            .then(response => response.json())
            .then(data => {
                if (data.error) {
                    console.error('Error loading data:', data.error);
                    return;
                }
                
                // Update metrics
                updateMetrics(data.metrics);
                updateHubStatus(data.health_status);
                updateAlerts(data.alerts, data.alert_summary);
                updateSystemStats(data.online_hubs, data.total_hubs, data.system_uptime, data.avg_response);
                
                console.log('Dashboard data loaded successfully');
            })
            .catch(error => {
                console.error('Failed to load dashboard data:', error);
                // Keep showing mock data if real data fails
            });
    });
    
    function updateMetrics(metrics) {
        // Update metric values if elements exist
        const metricElements = {
            'crs': document.querySelector('[data-metric="crs"]'),
            'sai': document.querySelector('[data-metric="sai"]'), 
            'fi': document.querySelector('[data-metric="fi"]'),
            'ts': document.querySelector('[data-metric="ts"]'),
            'cqs': document.querySelector('[data-metric="cqs"]')
        };
        
        Object.keys(metrics).forEach(key => {
            if (metricElements[key] && metrics[key] !== 'N/A') {
                metricElements[key].textContent = metrics[key].toFixed(1) + '%';
            }
        });
    }
    
    function updateHubStatus(healthStatus) {
        // Update hub status indicators
        console.log('Updating hub status:', Object.keys(healthStatus).length, 'hubs');
    }
    
    function updateAlerts(alerts, summary) {
        // Update alert counts and displays
        console.log('Updating alerts:', summary.total, 'total alerts');
    }
    
    function updateSystemStats(online, total, uptime, avgResponse) {
        // Update system statistics
        console.log('System stats - Online:', online, 'Total:', total, 'Uptime:', uptime + '%');
    }
    {% endif %}

    // Auto-refresh data every 30 seconds
    {% if preferences.auto_refresh %}
    setInterval(function() {
        // Refresh specific data without full page reload
        fetch('/api/dashboard-data')
            .then(response => response.json())
            .then(data => {
                if (!data.error) {
                    updateMetrics(data.metrics);
                    updateHubStatus(data.health_status);
                    updateAlerts(data.alerts, data.alert_summary);
                    updateSystemStats(data.online_hubs, data.total_hubs, data.system_uptime, data.avg_response);
                }
                console.log('Data refreshed:', data.timestamp);
            })
            .catch(error => console.error('Refresh error:', error));
    }, {{ (preferences.refresh_interval or 30) * 1000 }});
    {% endif %}

    // Add current time display
    function updateTime() {
        const now = new Date();
        const timeString = now.toLocaleTimeString('en-US', { 
            hour12: false, 
            hour: '2-digit', 
            minute: '2-digit' 
        });
        // Update time displays if they exist
        document.querySelectorAll('.current-time').forEach(el => {
            el.textContent = timeString;
        });
    }

    // Update time every second
    setInterval(updateTime, 1000);
    updateTime(); // Initial call

    // Async data loading to prevent layout issues
    async function loadDashboardData() {
        try {
            const response = await fetch('/api/dashboard-data');
            if (response.ok) {
                const data = await response.json();
                
                // Update metrics if elements exist
                if (data.metrics) {
                    updateMetricIfExists('crs-value', data.metrics.crs);
                    updateMetricIfExists('sai-value', data.metrics.sai);
                    updateMetricIfExists('fi-value', data.metrics.fi);
                    updateMetricIfExists('ts-value', data.metrics.ts);
                    updateMetricIfExists('cqs-value', data.metrics.cqs);
                }
                
                // Update system stats
                if (data.online_hubs !== undefined) {
                    updateMetricIfExists('online-hubs', data.online_hubs);
                }
                if (data.system_uptime !== undefined) {
                    updateMetricIfExists('system-uptime', data.system_uptime.toFixed(1) + '%');
                }
                if (data.avg_response !== undefined && data.avg_response !== null) {
                    updateMetricIfExists('avg-response', data.avg_response.toFixed(0) + 'ms');
                }
                
                console.log('Dashboard data updated successfully');
            }
        } catch (error) {
            console.warn('Failed to load live dashboard data:', error);
            // Continue with mock data - no need to show error to user
        }
    }

    function updateMetricIfExists(elementId, value) {
        const element = document.getElementById(elementId);
        if (element && value !== undefined && value !== null) {
            element.textContent = value;
        }
    }

    // Load real data after page is fully loaded
    document.addEventListener('DOMContentLoaded', function() {
        // Wait a bit for the page to settle, then load real data
        setTimeout(loadDashboardData, 1000);
        
        // Set up periodic updates if auto-refresh is enabled
        {% if preferences and preferences.auto_refresh %}
        setInterval(loadDashboardData, {{ (preferences.refresh_interval or 30) * 1000 }});
        {% endif %}
    });
</script>
{% endblock %}
